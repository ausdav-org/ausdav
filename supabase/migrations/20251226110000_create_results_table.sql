-- Remove results column from applicants table
alter table public.applicants drop column if exists results;

-- Add unique constraint on index_no in applicants for FK reference (must be done BEFORE creating results table)
do $$
begin
  if not exists (
    select 1 from pg_constraint where conname = 'applicants_index_no_unique'
  ) then
    alter table public.applicants add constraint applicants_index_no_unique unique(index_no);
  end if;
end $$;

-- Create results table with proper structure
create table if not exists public.results (
  result_id integer generated by default as identity primary key,
  
  -- Foreign key to applicants table
  index_no text not null references public.applicants(index_no) on delete cascade,
  
  -- Stream (Maths or Biology)
  stream text not null check (stream in ('Maths', 'Biology')),
  
  -- Subject marks (0-100)
  physics_marks numeric(5,2) null check (physics_marks is null or (physics_marks >= 0 and physics_marks <= 100)),
  chemistry_marks numeric(5,2) null check (chemistry_marks is null or (chemistry_marks >= 0 and chemistry_marks <= 100)),
  -- Maths OR Biology (only one applicable per stream)
  maths_marks numeric(5,2) null check (maths_marks is null or (maths_marks >= 0 and maths_marks <= 100)),
  bio_marks numeric(5,2) null check (bio_marks is null or (bio_marks >= 0 and bio_marks <= 100)),
  
  -- Grade boundaries per subject (A/B/C/S minimums)
  -- Physics grade bounds
  phy_a_min numeric(5,2) not null default 75,
  phy_b_min numeric(5,2) not null default 65,
  phy_c_min numeric(5,2) not null default 55,
  phy_s_min numeric(5,2) not null default 35,
  
  -- Chemistry grade bounds
  che_a_min numeric(5,2) not null default 75,
  che_b_min numeric(5,2) not null default 65,
  che_c_min numeric(5,2) not null default 55,
  che_s_min numeric(5,2) not null default 35,
  
  -- Biology grade bounds (for Biology stream)
  bio_a_min numeric(5,2) not null default 75,
  bio_b_min numeric(5,2) not null default 65,
  bio_c_min numeric(5,2) not null default 55,
  bio_s_min numeric(5,2) not null default 35,
  
  -- Maths grade bounds (for Maths stream)
  maths_a_min numeric(5,2) not null default 75,
  maths_b_min numeric(5,2) not null default 65,
  maths_c_min numeric(5,2) not null default 55,
  maths_s_min numeric(5,2) not null default 35,
  
  -- Computed grades (stored for quick access, computed from marks and bounds)
  physics_grade char(1) null check (physics_grade is null or physics_grade in ('A', 'B', 'C', 'S', 'F')),
  chemistry_grade char(1) null check (chemistry_grade is null or chemistry_grade in ('A', 'B', 'C', 'S', 'F')),
  maths_grade char(1) null check (maths_grade is null or maths_grade in ('A', 'B', 'C', 'S', 'F')),
  bio_grade char(1) null check (bio_grade is null or bio_grade in ('A', 'B', 'C', 'S', 'F')),
  
  -- Z-score (computed from total marks relative to stream)
  zscore numeric(10,4) null,
  
  -- Rank within stream (computed based on z-score)
  rank integer null,
  
  -- Year for filtering
  year integer not null,
  
  created_at timestamptz not null default now(),
  updated_at timestamptz not null default now(),
  
  -- Ensure one result per applicant
  unique(index_no)
);

-- Create indexes for performance
create index if not exists idx_results_index_no on public.results(index_no);
create index if not exists idx_results_stream on public.results(stream);
create index if not exists idx_results_year on public.results(year);
create index if not exists idx_results_rank on public.results(rank);
create index if not exists idx_results_zscore on public.results(zscore);

-- Enable RLS
alter table public.results enable row level security;

-- RLS policies: anyone can read, only authenticated with proper permissions can manage
create policy results_select_public
on public.results
for select
to anon, authenticated
using (true);

create policy results_manage
on public.results
for all
to authenticated
using (
  private.is_super_admin() or private.has_permission('applicant')
)
with check (
  private.is_super_admin() or private.has_permission('applicant')
);

-- Grant permissions
grant select on public.results to anon, authenticated;
grant insert, update, delete on public.results to authenticated;

-- Function to compute grade from marks
create or replace function compute_grade(
  marks numeric,
  a_min numeric,
  b_min numeric,
  c_min numeric,
  s_min numeric
)
returns char(1)
language plpgsql
immutable
as $$
begin
  if marks is null then return null; end if;
  if marks >= a_min then return 'A'; end if;
  if marks >= b_min then return 'B'; end if;
  if marks >= c_min then return 'C'; end if;
  if marks >= s_min then return 'S'; end if;
  return 'F';
end;
$$;

-- Function to compute z-scores and ranks for a given year and stream
create or replace function compute_results_rankings(p_year integer, p_stream text)
returns void
language plpgsql
as $$
declare
  mean_total numeric;
  std_total numeric;
  rec record;
  cur_rank integer := 0;
  last_zscore numeric := null;
  same_rank_count integer := 0;
begin
  -- Compute mean and standard deviation for the stream/year
  select 
    avg(
      coalesce(physics_marks, 0) + 
      coalesce(chemistry_marks, 0) + 
      case 
        when p_stream = 'Maths' then coalesce(maths_marks, 0)
        else coalesce(bio_marks, 0)
      end
    ),
    stddev_pop(
      coalesce(physics_marks, 0) + 
      coalesce(chemistry_marks, 0) + 
      case 
        when p_stream = 'Maths' then coalesce(maths_marks, 0)
        else coalesce(bio_marks, 0)
      end
    )
  into mean_total, std_total
  from public.results
  where year = p_year and stream = p_stream
    and physics_marks is not null
    and chemistry_marks is not null
    and (
      (p_stream = 'Maths' and maths_marks is not null) or
      (p_stream = 'Biology' and bio_marks is not null)
    );

  -- Handle edge cases
  if mean_total is null then mean_total := 0; end if;
  if std_total is null or std_total = 0 then std_total := 1; end if;

  -- Update z-scores
  update public.results r
  set zscore = (
    coalesce(r.physics_marks, 0) + 
    coalesce(r.chemistry_marks, 0) + 
    case 
      when p_stream = 'Maths' then coalesce(r.maths_marks, 0)
      else coalesce(r.bio_marks, 0)
    end - mean_total
  ) / std_total
  where r.year = p_year and r.stream = p_stream
    and r.physics_marks is not null
    and r.chemistry_marks is not null
    and (
      (p_stream = 'Maths' and r.maths_marks is not null) or
      (p_stream = 'Biology' and r.bio_marks is not null)
    );

  -- Compute ranks based on z-score (higher z-score = rank 1)
  cur_rank := 0;
  for rec in 
    select result_id, zscore
    from public.results
    where year = p_year and stream = p_stream and zscore is not null
    order by zscore desc
  loop
    if last_zscore is null or rec.zscore != last_zscore then
      cur_rank := cur_rank + same_rank_count + 1;
      same_rank_count := 0;
    else
      same_rank_count := same_rank_count + 1;
    end if;
    
    update public.results
    set rank = cur_rank
    where result_id = rec.result_id;
    
    last_zscore := rec.zscore;
  end loop;
end;
$$;

-- Function to insert/update result with auto-computed grades
create or replace function upsert_result(
  p_index_no text,
  p_stream text,
  p_year integer,
  p_physics_marks numeric default null,
  p_chemistry_marks numeric default null,
  p_maths_marks numeric default null,
  p_bio_marks numeric default null,
  p_phy_a_min numeric default 75,
  p_phy_b_min numeric default 65,
  p_phy_c_min numeric default 55,
  p_phy_s_min numeric default 35,
  p_che_a_min numeric default 75,
  p_che_b_min numeric default 65,
  p_che_c_min numeric default 55,
  p_che_s_min numeric default 35,
  p_bio_a_min numeric default 75,
  p_bio_b_min numeric default 65,
  p_bio_c_min numeric default 55,
  p_bio_s_min numeric default 35,
  p_maths_a_min numeric default 75,
  p_maths_b_min numeric default 65,
  p_maths_c_min numeric default 55,
  p_maths_s_min numeric default 35
)
returns void
language plpgsql
as $$
begin
  insert into public.results (
    index_no, stream, year,
    physics_marks, chemistry_marks, maths_marks, bio_marks,
    phy_a_min, phy_b_min, phy_c_min, phy_s_min,
    che_a_min, che_b_min, che_c_min, che_s_min,
    bio_a_min, bio_b_min, bio_c_min, bio_s_min,
    maths_a_min, maths_b_min, maths_c_min, maths_s_min,
    physics_grade, chemistry_grade, maths_grade, bio_grade
  ) values (
    p_index_no, p_stream, p_year,
    p_physics_marks, p_chemistry_marks, p_maths_marks, p_bio_marks,
    p_phy_a_min, p_phy_b_min, p_phy_c_min, p_phy_s_min,
    p_che_a_min, p_che_b_min, p_che_c_min, p_che_s_min,
    p_bio_a_min, p_bio_b_min, p_bio_c_min, p_bio_s_min,
    p_maths_a_min, p_maths_b_min, p_maths_c_min, p_maths_s_min,
    compute_grade(p_physics_marks, p_phy_a_min, p_phy_b_min, p_phy_c_min, p_phy_s_min),
    compute_grade(p_chemistry_marks, p_che_a_min, p_che_b_min, p_che_c_min, p_che_s_min),
    compute_grade(p_maths_marks, p_maths_a_min, p_maths_b_min, p_maths_c_min, p_maths_s_min),
    compute_grade(p_bio_marks, p_bio_a_min, p_bio_b_min, p_bio_c_min, p_bio_s_min)
  )
  on conflict (index_no) do update set
    stream = excluded.stream,
    year = excluded.year,
    physics_marks = excluded.physics_marks,
    chemistry_marks = excluded.chemistry_marks,
    maths_marks = excluded.maths_marks,
    bio_marks = excluded.bio_marks,
    phy_a_min = excluded.phy_a_min,
    phy_b_min = excluded.phy_b_min,
    phy_c_min = excluded.phy_c_min,
    phy_s_min = excluded.phy_s_min,
    che_a_min = excluded.che_a_min,
    che_b_min = excluded.che_b_min,
    che_c_min = excluded.che_c_min,
    che_s_min = excluded.che_s_min,
    bio_a_min = excluded.bio_a_min,
    bio_b_min = excluded.bio_b_min,
    bio_c_min = excluded.bio_c_min,
    bio_s_min = excluded.bio_s_min,
    maths_a_min = excluded.maths_a_min,
    maths_b_min = excluded.maths_b_min,
    maths_c_min = excluded.maths_c_min,
    maths_s_min = excluded.maths_s_min,
    physics_grade = compute_grade(excluded.physics_marks, excluded.phy_a_min, excluded.phy_b_min, excluded.phy_c_min, excluded.phy_s_min),
    chemistry_grade = compute_grade(excluded.chemistry_marks, excluded.che_a_min, excluded.che_b_min, excluded.che_c_min, excluded.che_s_min),
    maths_grade = compute_grade(excluded.maths_marks, excluded.maths_a_min, excluded.maths_b_min, excluded.maths_c_min, excluded.maths_s_min),
    bio_grade = compute_grade(excluded.bio_marks, excluded.bio_a_min, excluded.bio_b_min, excluded.bio_c_min, excluded.bio_s_min),
    updated_at = now();
end;
$$;
